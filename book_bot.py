import os
import logging
import requests
import asyncio
from telegram import Update, InputFile
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from openai import OpenAI
from urllib.parse import urlparse

# ----------------------------------------------------------------------
# 1. ุฅุนุฏุงุฏุงุช ุงููุชุบูุฑุงุช ูุงูููุงุชูุญ
# ----------------------------------------------------------------------

TELEGRAM_BOT_TOKEN = os.environ.get("BOT_TOKEN")
OPENAI_API_KEY = os.environ.get("AI_KEY")

# ุฅุนุฏุงุฏุงุช ุงูุชุณุฌูู (Logging)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ุฅุนุฏุงุฏ ุนููู OpenAI
if OPENAI_API_KEY:
    openai_client = OpenAI(api_key=OPENAI_API_KEY)
else:
    logger.warning("โ ููุชุงุญ AI_KEY ุบูุฑ ููุฌูุฏ. ุณูุชู ุชุนุทูู ููุฒุฉ ุงูุชุญููู ุงูุฐูู.")


# ----------------------------------------------------------------------
# 2. ูุธุงุฆู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุจุญุซ ุงููุชูุฏู
# ----------------------------------------------------------------------

async def get_synthesis_analysis(book_title: str) -> str:
    """
    ูุทูุจ ุชุญูููุงู ุนูููุงู ูุชุทุจููุงู ุนูููุงู ูููุชุงุจ ูู OpenAI (ูุงุณู ุงูุญููุฉ).
    (ุงูููุฏ ููุง ูู ุงูุฑุฏ ุงูุณุงุจูุ ูุณุชุฎุฏู GPT-4o-mini)
    """
    if not OPENAI_API_KEY:
        return "โ๏ธ ูุง ูููููู ุฅูุดุงุก ุชุญูููุ ููุชุงุญ AI_KEY ููููุฏ. (ุงููุงุณู ูู ุณุจุงุช ุนููู)."
    
    system_prompt = (
        "ุฃูุช 'ูุงุณู ุงูุญููุฉ'ุ ุฎุจูุฑ ุฃุฏุจู ููููุณูู ูุญูู ุงููุชุจ ุงูุฃูุซุฑ ุดูุฑุฉ ุนุงูููุงู. "
        "ูููุชู ูู ุชูุฏูู ุชุญููู ุนููู ููุญูุฒุ ูุฑูุฒ ุนูู ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ ูููุชุงุจุ "
        "ูููู ูููู ููุฌูููุฑ ุงูุญุฏูุซ ุชุทุจูู ุฏุฑูุณู ุงูุฎุงูุฏุฉ ุนูู ุชุญุฏูุงุชูู ุงูููููุฉ."
        "ุงุฌุนู ุงูุฅุฌุงุจุฉ ููุณูุฉ ุฅูู ุซูุงุซ ููุงุท ุฑุฆูุณูุฉ (ุจุดูู ููุงุท) ููุฏููุง ุจุฃุณููุจ ุจูุงุบู ูุคุซุฑ."
    )
    
    user_prompt = f"ูุฏู ุชุญูููู ุงูุฃุณุทูุฑู ููุชุงุจ ุจุนููุงู: '{book_title}'."
    
    try:
        response = await asyncio.to_thread(
            openai_client.chat.completions.create,
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            max_tokens=700
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู OpenAI API: {e}")
        return "โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุงุณุชุฏุนุงุก ุญููุฉ ุงููุงุณู."

# ----------------------------------------------------------------------
# 3. ูุธููุฉ ุงูุจุญุซ ุงูุจุฏููุฉ (ุงูุจุญุซ ุงูุนุงุฏู ุจุฏูู API)
# ----------------------------------------------------------------------

async def simple_file_search(book_title: str) -> tuple[str | None, str | None]:
    """
    ูููู ุจุงูุจุญุซ ุนู ุฑุงุจุท ูุจุงุดุฑ ุจุงุณุชุฎุฏุงู ุงุณุชุนูุงู ุจุญุซ Google ุงูุนุงุฏู
    ุจุฏูู ุงุณุชุฎุฏุงู ููุงุชูุญ Google API ุงููุนูุฏุฉุ ูุน ุงูุชุฑููุฒ ุนูู ููุงูุน ุงูููุชุจุงุช.
    """
    
    # ๐จ ุชู ุฏูุฌ ุฃูุถู ุงุณุชุฑุงุชูุฌูุฉ ุจุญุซ ููุง (ุจุฏูู ููุงุชูุญ API)
    # ุณูุณุชุฎุฏู ุงุณุชุนูุงู ุจุญุซ ุฌูุฌู ุงููุจุงุดุฑ (Google Search Query)
    # ูุฐุง ุงูููุน ูู ุงูุจุญุซ ูุชู ุชูููุฐู ูุฏููุงู ูู ูุจููุงุ ูุง ูุญุชุงุฌ ููุชุงุญ API ููุง.
    
    search_query = f"ููู pdf ูุชุงุจ {book_title} site:kutub.info OR site:pdf-books.org"
    
    # ููุฃุณูุ ูุง ูููู ุชูููุฐ ุจุญุซ Google ุจุดูู ุขูู ุฏุงุฎู ุงูููุฏ ุจุฏูู API ุฃู ููุชุจุงุช ูุนูุฏุฉ (ูุซู BeautifulSoup)
    # ูุญู ุงููุดููุฉ ุจุดูู ููุฑู ูุงูุชุญูู ุฅูู ูููุฐุฌ "ุงููุงุณู ูุงูุจุงุญุซ"ุ ุณูุญุชุงุฌ ุฅูู ุชุจุณูุท ุงูุฃูุฑ:
    
    # **ุงูุญู ุงููุจุชูุฑ:** ุณูุทูุจ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุฅูุดุงุก ุฑุงุจุท ุจุญุซ Google ูุจุงุดุฑ (Google Search URL) 
    # ูุชููุฒ ุจุงูุฌูุฏุฉุ ุซู ูุทูุจ ูู ุงููุณุชุฎุฏู ุงูุจุญุซ ูุฏููุงู (ูุฅุฌุฑุงุก ูุคูุช) 
    # ุฃู ูุณุชุฎุฏู ุทุฑููุฉ ุฅุฑุณุงู ุงููููุงุช ุฅุฐุง ูุงู ูุฏูู ููู ูุฎุฒู.
    
    # ูุธุฑุงู ูููููุฏุ ูุฅู ุงูุทุฑููุฉ ุงูุฃูุซุฑ ุงุจุชูุงุฑุงู ูู ุฅุฑุณุงู ูููุงุช **ูุฎุฒูุฉ ูุณุจูุงู**
    # ุฃู **ุฅุฑุณุงู ุฑุงุจุท ุงูุจุญุซ ุงููุจุงุดุฑ ูููุณุชุฎุฏู** ููุชุญูู ููู.

    # ๐ก ุณูุณุชุฎุฏู ุงูุขู ูููุฐุฌ "ุงูุฑุงุจุท ุงููุจุงุดุฑ ููุจุญุซ ุงููุชูุฏู":
    encoded_query = requests.utils.quote(search_query)
    google_search_url = f"https://www.google.com/search?q={encoded_query}&tbm=nws" # (ุชุบููุฑ ููุน ุงูุจุญุซ ุงุฎุชูุงุฑู)

    return None, google_search_url # ูุฑุฌุน ุฑุงุจุท ุงูุจุญุซ ุจุฏูุงู ูู ุงูููู


# ----------------------------------------------------------------------
# 4. ุฏูุงู ุชููุฌุฑุงู ูุงูููุทู ุงูุฑุฆูุณู
# ----------------------------------------------------------------------

# ุฏุงูุฉ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "๐ฎ ุฃููุงู ุจู ูู ุจูุช ูุงุณู ุงูุญููุฉ ูุงูุจุงุญุซ ุงูุญุตุฑู!\n"
        "ุฃุฑุณู ุงุณู ุฃู ูุชุงุจ: ุณุฃููุญู ุชุญููู ุงููุงุณู ุงูุฃุณุทูุฑู (AI) ูุฃุจุญุซ ูู ุนู ุงูููู ุงููุจุงุดุฑ (PDF).\n"
    )

# ุฏุงูุฉ ุงูุชุนุงูู ูุน ุงูุฑุณุงุฆู ุงููุตูุฉ
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    book_title = update.message.text.strip()
    logger.info(f"ุชูููุช ุทูุจ ุชุญููู ูุจุญุซ ุนู: {book_title}")
    
    # 1. ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุดุบูู
    await update.message.reply_text(
        f"โณ ุงููุงุณู ูุชุฃูู ูู ุญููุฉ ูุชุงุจ '{book_title}'...\n"
        "ุฌุงุฑู ุตูุงุบุฉ ุงูุชุญููู ุงูุนููู ูุงูุจุญุซ ุนู ุงูููู."
    )
    
    # 2. ุทูุจ ุงูุชุญููู ุงูุฃุณุทูุฑู (ูุง ูุคุซุฑ ุนููู ูุดู ุงูุจุญุซ)
    analysis_result = await get_synthesis_analysis(book_title)
    
    # 3. ูุญุงููุฉ ุงูุจุญุซ ุนู ุงูููู
    pdf_link, search_url = await simple_file_search(book_title)

    # 4. ุชุฌููุน ุงูุฑุณุงูุฉ ุงูููุงุฆูุฉ
    
    # ุฅุฐุง ูู ูุชููู ูู ุฌูุจ ููู ูุจุงุดุฑุ ุณูุฑุณู ุฑุงุจุท ุจุญุซ ูุชูุฏู ูููุณุชุฎุฏู
    if not pdf_link:
        final_message = (
            f"๐ **ุงูุชุญููู ุงูุฃุณุทูุฑู ููุงุณู ุงูุญููุฉ:**\n"
            f"**ุงููุชุงุจ ุงูููุญูู:** {book_title}\n\n"
            f"{analysis_result}\n\n"
            f"โฌ๏ธ **ุงูุจุญุซ ุงููุจุงุดุฑ ุนู ุงูููู (PDF):**\n"
            f"ูู ุฃุชููู ูู ุฌูุจ ุงูููู ุจุดูู ุขููุ ููู ููููู ุฒูุงุฑุฉ ูุฐุง ุงูุฑุงุจุท ุงููุฎุตุต ููุนุซูุฑ ุนููู ูุจุงุดุฑุฉู:\n"
            f"[ุฑุงุจุท ุงูุจุญุซ ุงููุชูุฏู]({search_url})"
        )
    else:
        # ูุฐู ุงูุญุงูุฉ ูู ุชุชุญูู ุฅูุง ุฅุฐุง ูุงู ููุงู API ุจุญุซ ููู (ูุญุฐูู ุญุงููุงู)
        final_message = (
            f"๐ **ุงูุชุญููู ุงูุฃุณุทูุฑู ููุงุณู ุงูุญููุฉ:**\n"
            f"**ุงููุชุงุจ ุงูููุญูู:** {book_title}\n\n"
            f"{analysis_result}\n\n"
            f"โ **ุชู ุงูุนุซูุฑ ุนูู ุงูููู!**\n"
            f"ุฌุงุฑู ุฅุฑุณุงู ุงูููู ุงููุจุงุดุฑ..."
        )
        
    await update.message.reply_markdown(final_message)
    
    # ๐ก ุฎุทูุฉ ุฅุถุงููุฉ: ุฅุฑุณุงู ุงูููู ุงููุจุงุดุฑ
    if pdf_link:
        try:
            # ููุง ูุฌุจ ุฅุถุงูุฉ ููุฏ ูุชุญููู ุงูููู ูุฅุฑุณุงูู ุจุงุณุชุฎุฏุงู telegram.InputFile
            # ูุฐุง ูุชุทูุจ ุฃู ูููู ุงูุฑุงุจุท ุงูููุชุดู (pdf_link) ูุนูู ููุจุงุดุฑ ูููู PDF
            
            # ูุซุงู ุนูู ููุฏ ุฅุฑุณุงู ููู (ูุชุทูุจ ุฃู ูููู ุงูููู ููุฌูุฏุงู ููุญููุงู)
            response = requests.get(pdf_link, stream=True, timeout=30)
            response.raise_for_status()
            
            # ุงุณุชุฎุฏุงู ุงุณู ุงููุชุงุจ ูุงุณู ููููู
            file_name = f"{book_title}.pdf"
            
            # ุฅุฑุณุงู ุงูููู
            await update.message.reply_document(
                document=InputFile(response.content, filename=file_name), 
                caption=f"ูุฐุง ูู ููู {book_title} ุงูุฐู ุทูุจู ุงููุงุณู."
            )

        except Exception as e:
            logger.error(f"โ ูุดู ูู ุชุญููู ูุฅุฑุณุงู ููู PDF ูู ุงูุฑุงุจุท: {e}")
            await update.message.reply_text(
                "โ ุนุฐุฑุงูุ ูุดูุช ุนูููุฉ ุชุญููู ูุฅุฑุณุงู ุงูููู ูู ุงูุฑุงุจุท ุงูุฐู ุชู ุงูุนุซูุฑ ุนููู."
            )


# ----------------------------------------------------------------------
# 5. ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ููุชุดุบูู
# ----------------------------------------------------------------------

def main():
    telegram_token = os.environ.get("BOT_TOKEN") 
    
    if not telegram_token:
        logger.error("๐ซ ูุดู ุงูุจุฏุก: ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑูุฒ ุงูุชููู (BOT_TOKEN).")
        return

    application = ApplicationBuilder().token(telegram_token).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message)) 

    logger.info("โ ุจูุช ูุงุณู ุงูุญููุฉ ูุงูุจุงุญุซ ุงูุญุตุฑู ูุนูู ุงูุขู...")
    application.run_polling()

if __name__ == '__main__':
    main()
